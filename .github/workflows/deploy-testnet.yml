name: Deploy to Testnet

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      network:
        description: "Network to deploy to"
        required: true
        default: "monad"
        type: choice
        options:
          - monad
          - mumbai

jobs:
  deploy:
    name: Deploy Contracts
    runs-on: ubuntu-latest
    environment: testnet
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Compile contracts
        run: bun run compile

      - name: Deploy to network
        run: |
          if [ "${{ github.event.inputs.network }}" == "" ]; then
            bun run deploy:monad
          else
            bun run deploy:${{ github.event.inputs.network }}
          fi
        env:
          PRIVATE_KEY: ${{ secrets.TESTNET_PRIVATE_KEY }}
          MONAD_RPC: ${{ secrets.MONAD_RPC }}
          MUMBAI_RPC: ${{ secrets.MUMBAI_RPC }}

      - name: Verify contracts
        run: bun run verify
        env:
          ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
          POLYGONSCAN_API_KEY: ${{ secrets.POLYGONSCAN_API_KEY }}
        continue-on-error: true

      - name: Upload deployment artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deployment-addresses
          path: deployments/latest.json

      - name: Notify deployment
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const deployment = JSON.parse(fs.readFileSync('deployments/latest.json', 'utf8'));
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸš€ Deployment successful to **${deployment.network}**!\n\n` +
                    `**Contracts:**\n` +
                    `- AgentIdentityRegistry: \`${deployment.contracts.AgentIdentityRegistry}\`\n` +
                    `- ReputationRegistry: \`${deployment.contracts.ReputationRegistry}\`\n` +
                    `- BountyRegistry: \`${deployment.contracts.BountyRegistry}\`\n` +
                    `- BountyEscrow: \`${deployment.contracts.BountyEscrow}\`\n\n` +
                    `Deployed by: ${deployment.deployer}`
            });

  docker-build:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/agent-bounty-hunter:latest
            ${{ secrets.DOCKER_USERNAME }}/agent-bounty-hunter:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy to server (optional)
        if: ${{ vars.AUTO_DEPLOY == 'true' }}
        run: |
          echo "Auto-deploy logic here (SSH to server, docker-compose pull, etc.)"
          # ssh user@server "cd /app && docker-compose pull && docker-compose up -d"
